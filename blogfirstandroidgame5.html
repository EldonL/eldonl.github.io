<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Android Game - Eldon Lin Portfolio</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/blogproject.css">
    <script src="js/app.js" defer></script>
    <script src="js/component/header.js" defer></script>
    <script src="js/component/footer.js" defer></script>
    <script src="js/component/logo.js" defer></script>
    <script src="js/component/blogintro.js" defer></script>
    <script src="js/component/blogcontent.js" defer></script>
    <script src="js/component/blogrecent.js" defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>
<body>

    <section class="bg-js-controlled">
        <header-component></header-component>
    </section>
    
    <section class="bg-js-controlled">
        <section class="intro">
            <blogintro-component>
                <span slot ="title">First Android Game - Part 5</span>
                <span slot="date">July 1, 2023</span>
                <button slot="vlogbutton" onclick="OnLinkClick('https://www.youtube.com/playlist?list=PLJJXiMHWLgloHkx0DWFJtN_Min3OEU-T4')">Watch youtube playlist</span>
               
            </blogintro-component>
        </section>
    
    
            <section class="diarypost">
                <blogcontent-component>
                    <span slot ="action1text">This is part 5 of making my first Android Game. If you missed part4, you can find it <a href="blogfirstandroidgame4.html">here</a></span>
                    <span slot ="action2text">Currently when the player collides with the enemy it gets disabled, goes back to its original position and get reneabled. However this does not sync across the network. So I changed the code to call a RPC function in OnTriggerEnter2D</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon56.PNG" slot="action2image">
                    <span slot ="action3text">I disabled the explosions code as the explosions are not synced across yet. The RPC function will call a coroutine. The coroutine is doing the same thing as before I synced the collisions across the network. You can also find a video version on youtube <a href="https://youtu.be/3MLtRu2iGJY">here</a></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon57.PNG" slot="action3image">
                    <span slot ="action4text">Since the boxcollider2D is attached to the parent of the player, and the gameobject being SetActive(false) is on the child. I needed to disable the boxcollider2D and renable to avoid player getting collided with other gameobjects even though the player is invisible. I created a BoxCollider2D variable. In Awake() I would Get the Component of the BoxCollider2D. Then in the Coroutine I would enable and disable it. You can also find a video version on youtube <a href="https://youtu.be/OemQcaoTdDk">here</a></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon58.PNG" slot="action4image">
                    <span slot ="action5text">If the user does not enter a name and decides to click on the Connect button in the mainmenu, nothing will happen. This is bad UI design because the user has no feedback. So I added a error text that will get enabled when this edge case occurs. In ConnectToServer.cs, I added a TextMeshProUGUI variable called errorText. This gameobject is disabled in Awake. It is enabled and its text is changed to "Enter name" when the user does not enter a name and selects connect. </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon59.PNG" slot="action5image">
                    <span slot ="action6text">Now the usr will see this error feedback which is a better design.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon60.PNG" slot="action6image">
                    <span slot ="action7text">I did the same thing in the Lobby when the user tries to create a room but does not enter a name</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon61.PNG" slot="action7image">
                    <span slot ="action8text">I noticed in the Lobby, when the "Create" button is pressed, there is no feedback given to the user. So I decided to do the same thing as the main menu and changed "Create" to "Creating" when the user presses the button. However, if the user leaves the room and back to the lobby, the "Creating..." text was still there. This is because I am still in the same scene. So I created a LobbyCreateButton.cs that has a string property called ButtonText. This will update the text on the button. When the button is enabled -which occurs when entering the scene or leaving the room - then the button text displays "Create".</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon62.PNG" slot="action8image">
                    <span slot ="action9text">In LobbyManager, instead of referencing the TextMeshProUGUI, I create a LobbyCreateButton variable called createButtonText. This way I can reference the ButtonText property.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon63.PNG" slot="action9image">
                    <span slot ="action10text">The CreateButton will say "Creating..." or "Create" depending on the scenarios I mentioned above</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon64.PNG" slot="action10image">
                    <span slot ="action11text">When the user presses the connect button in the main menu, the user can still press the connect button. So I made sure to disable them to prevent the user from pressing connect multiple times which can result in this warning</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon65.PNG" slot="action11image">
                    <span slot ="action12text">The disabled state of the button looks like this</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon66.PNG" slot="action12image">
                    <span slot ="action13text">Simlarily, when the user is trying to create a room and clicks create multiple times, this error will occur</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon67.PNG" slot="action13image">
                    <span slot ="action14text">So in LobbyCreateButton.cs, I added a boolean property called PressButton. This let's me set when the button is interactable</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon68.PNG" slot="action14image">
                    <span slot ="action15text">The disabled state of the button looks like this. You can see the video version <a href="https://youtu.be/PXKdG2JMcQo">here</a></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon69.PNG" slot="action15image">
                    <span slot ="action16text">Updating the score requires syncing across the network as well. The Asteroid game example from the PUN2 asset had its own score system. So I took a look at that. First I used PlayerOverViewPanel.cs as my example. I created a TestScorePanel.cs script. In the Awake, I create a dictionary that will store the Photon.Realtime.Player ActorNumber as the key and the Score gameobjects as the value. This way I can search for which player's score I want to modify. I would loop through the PlayerList which will contain all the players that had entered the lobby. For each player in the list, I would spawn the Score gameobject. In this case, the ScoreGameobject would be childed to a gameobject that has the horizontal layout group so the score prefab won't overlap. I would then set the text to the player's name, score and lives. These are the initial values at the start of the game</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon70.PNG" slot="action16image">
                    <span slot ="action17text">OnPlayerPropertiesUpdate would be needed because when SetCustomProperties is called, it will call OnPlayerPropertiesUpdate. In this function I would look for my player in the dictionary and get the score gameobject. I would pass update my score and lives. The score would the most updated because of GetScore().</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon71.PNG" slot="action17image">
                    <span slot ="action18text">Then there is the PunPlayerScores.cs. This would be the script example I used for TestPlayerScore.cs. The first function would be SetScore. Note that it passes in this Photon.Realtime.Player. This means I won't need to pass in the Photon.Realtime.Player. The script would need to be static in this case. I store "score" in the hashtable score variable. I would then update this player's custom properties by calling SetCustomProperties. This would automatically call OnPlayerPropertiesUpdate() from TestScorePanel.cs</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon72.PNG" slot="action18image">
                    <span slot ="action19text">Then there AddScore(). Similar to SetScore but it would add to the current score</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon73.PNG" slot="action19image">
                    <span slot ="action20text">Last is GetScore().This would return this player's score which is stored in the custom properties</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon74.PNG" slot="action20image">
                    <span slot ="action21text">Last sample script I references was ScoreHelper.cs. I created a TestScoreHelper.cs. In Update(), I would say if the mouse is clicked which is equivalent to if the screen is tapped, check if local player exists then set the score.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon75.PNG" slot="action21image">
                    <span slot ="action22text">I created a Test Scene. It contains a TestPanel gameobject. This has an Image component, TestScorePanel(Script) component and a Horizontal Layout group component. The ScoreHelper gameobject has the TestScoreHelper(Script) component. The TestPlayerScore.cs is not in the scene, and can be referenced because it is static</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon76.PNG" slot="action22image">
                    <span slot ="action23text">I made a build with MainMenu, Lobby and TestScene. And the Score was being updated and synced!</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon77.gif" slot="action23image">
                    <span slot ="action24text">Now I had to move over the same logic to the actual game. I want to sync up the score and coins. Since a lot of code for the scores were based on ScoreManager.Instance - this would not work with this logic. So I had to comment those out. I first created a PlayerTextInformation.cs. This is so I have access to the scores and coins text. Unlike the test I did, the text was the gameobject itself so I could GetComponent TextMeshProUGUI. In this case, I would GetComponent PlayerTextInformation to access the Properties Coin or Score</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon78.PNG" slot="action24image">
                    <span slot ="action25text">This script is attached to PlayerTextInformation prefab which will contain the players name, lives, coin count and score.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon79.PNG" slot="action25image">
                    <span slot ="action26text">Using TestPlayerScore.cs as the example, I transferred the same logic over to PlayerInformation.cs and included a const string for coin and score</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon80.PNG" slot="action26image">
                    <span slot ="action27text">On the Scoreboard prefab. The player's information has been removed, because the PlayerTextInformation will be spawned on to the "UI board Small parchment" which contains a horizontal layout group. The Scoreboard prefab has the ScoreManager(Script) component </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon81.PNG" slot="action27image">
                    <span slot ="action28text">The ScoreManager.cs is based on TestScorePanel.cs. The difference is instead of GetComponent TextMeshProUGUI to get the Score and Coins, I GetComponent PlayerTextInformation and access the Properties Coins and Score</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon82.PNG" slot="action28image">
                    <span slot ="action29text">Anywhere I was adding score or coins I would change it to the new GetCoin() and GetScore(). This includes the bullet hitting the enemy to add score</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon83.PNG" slot="action29image">
                    <span slot ="action30text">As well as player collecting coins</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon84.PNG" slot="action30image">
                    <span slot ="action31text">I tested to see if this working by testing with the editor and on a mobile build. The score appears to be syncing. The coins however was being incremented for both players even if only one player is collecting the coins. Reminder that because of the new photon code, all the codes for when to spawn the enemies, subtracting lives are commented out. The player's names are not implemented yet and the bullets are not synced across the network yet</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon85.gif" slot="action31image">
                    <span slot ="action32text">I was getting an error when I attempt to GetCoins()</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon86.PNG" slot="action32image">
                    <span slot ="action33text">The null reference error was because I deleted the check to see if player collieded with an gameobject with the tag CoinA, CoinB or CoinC. However, when 1 player collects the coins, both player's coins are still increased. I am guessing the reason the score isn't increasing for both players is because the bullets are not synced across the network yet. Therefore, it looks like the score is behaving correctly. This however does not tell me why the coins are increasing.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon87.PNG" slot="action33image">
                    <span slot ="action34text">Turns out the solution was to add view.IsMine so that the only correct coins count increases for that player.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon88.PNG" slot="action34image">
                    <span slot ="action35text">Voila! Example of the correct score and coin count being incremented and synced across the network</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon89.PNG" slot="action35image">
                    <span slot ="action35text">Next is to display the correct NickName. I created a NickName property in PlayerTextInformation. Then assigned the player's nickname in ScoreManager</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon90.PNG" slot="action35image">
                    <span slot ="action36text">However, the name that I typed on the local player is displayed for both players. This is wrong!</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon91.PNG" slot="action36image">
                    <span slot ="action37text">The reason that the nickname was wrong is because i was using PhotonNetwork.LocalPlayer.NickName instead of Photon.Realtime.Player.NickName</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon92.PNG" slot="action37image">
                    <span slot ="action38text">The result of the correct nicknames being displayed.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon93.PNG" slot="action38image">
                    <span slot ="action39text">Although the score, coins and nicknames are synced. The lives are not synced yet. I looked at the Asteroid example. In PlayerListEntry.cs. In the Start(), the script would SetCustomProperty for the lives and would set the initial score as well. For now, let's ignore the Player ready you see in the image. We may or may not come back to that in this or another blog</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon94.PNG" slot="action39image">
                    <span slot ="action40text">The PlayerListEntry.cs is attached to the PlayerListEntry prefab in the Asteroid sample.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon95.PNG" slot="action40image">
                    <span slot ="action41text">I did not set the score before entering the game in the lobby (and for sure I didn't set the lives yet). So let's set the score. Since setting it to 0 would be hard to tell if the game is working since by default I've set it to 0. So I set the score to 7 as a test.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon96.PNG" slot="action41image">
                    <span slot ="action42text">I checked the game and the score is set to 7. I changed 7 to 0 because I know the score is set properly</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon97.PNG" slot="action42image">
                    <span slot ="action43text">Now I need to set the coins as well</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon98.PNG" slot="action43image">
                    <span slot ="action44text">Time to get the lives in. The Asteroid sample has a AsteroidGame.cs. This script is not Monobehaviour. AsteroidGame.cs stores data such as const int PLAYER_MAX_LIVES as well as const string PLAYER_LIVES which will be used as the key for our ExitGames.Client.Photon.HashTable </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon99.PNG" slot="action44image">
                    <span slot ="action45text">Using the sample above, I created a TomatoGame.cs which stores the int PLAYER_MAX_LIVES and string PLAYER_LIVES</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon100.PNG" slot="action45image">
                    <span slot ="action46text">Then in PlayerItem.cs, I would set the PLAYER_LIVES to PLAYER_MAX_LIVES because this is the default amount of lives before player enters the game. This is so the hashtable value contains the max lives. This is the same idea as what PlayerListEntry.cs did from the Asteroid sample</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon101.PNG" slot="action46image">
                    <span slot ="action47text">In PlayerTextInformation.cs I would create a Lives property of type string. It would get and set the field lives.text to display the lives on the </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon102.PNG" slot="action47image">
                    <span slot ="action48text">In ScoreManager.cs, I would set the Lives property to PLAYER_MAX_LIVES in Awake(). This is so the text on the scoreboard shows the number of lives. This is the same idea as the Asteroid sample's PlayerOverViewPanel.cs</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon103.PNG" slot="action48image">
                    <span slot ="action49text">Before I continue, I did a quick test to make sure the lives are being set to the value I set in PLAYER_MAX_VALUES</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon104.PNG" slot="action49image">
                    <span slot ="action50text">OnPlayerPropertiesUpdate() I would set the lives the the Photon.Realtime.Player.CustomProperties[TomatoGame.PLAYER_LIVES]. This hopefully would sync the lives up across the network when a SetCustomProperties is called</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon105.PNG" slot="action50image">
                    <span slot ="action51text">Using the Asteroid sample's Spaceship.cs as the example. In Player.cs of my own script, when the player collides with the enemy, in HitByEnemyRoutine(), I would check if PLAYER_LIVES is in the hashtable for this player, if yes, modify the value of PLAYER_LIVES, if it's less then or equal to 1, set lives to 0, otherwise subtract 1.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon106.PNG" slot="action51image">
                    <span slot ="action52text">As a comparison, here is Spaceship.cs from Asteroid sample. They are using PhotonNetwork.LocalPlayer.CustomProperties. This would result in the same player the way I did it. I just happen to have the player passed into the parameter.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon108.PNG" slot="action52image">
                    <span slot ="action53text">From the build, you can see the lives are synced up. The screen is showing the editor, but the player moving is the mobile, and when the lives are decreased, the editor see the lives decreasing as well</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon107.gif" slot="action53image">
                    <span slot ="action54text">In Player.cs, I added the PunRPC attribute to the Shoot method because I want the bullet to sync across the network.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon109.PNG" slot="action54image">
                    <span slot ="action55text">In Bullet.cs, I removed enabling and disabling code. The bullet would be destroyed after timeBeforeDestroy (in seconds) </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon110.PNG" slot="action55image">
                    <span slot ="action56text">In Player.cs, in the Update() instead of calling the BulletPoolInstance, I call the RPC function Shoot(). Note that I am using RPCTarget.AllViaServer so that the order of who shot first is correct</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon111.PNG" slot="action56image">
                    <span slot ="action57text">I made a build and you can see that one player can see the bullets of both players. However, notice that there are some new bugs: score is being increased for both players, the bullet is still shooting even when the player is destroyed.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon112.gif" slot="action57image">
                    <span slot ="action58text">To resolve the score increasing for both players instead of itself. In Bullet.cs, there is a InitializeBullet function that would assign the Owner property of type Photon.Realtime.Player to owner field that is passed in from the Player.cs script. In OnTriggerEnter2D, instead of adding score the PhotonNetWork.LocalPlayer, I used the Owner property to call the AddScore.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon112.PNG" slot="action58image">
                    <span slot ="action59text">In Player.cs in the Shoot() function, is where InitializeBullet function is called and the PhotonView.Owner is passed in to InitializeBullet.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon113.PNG" slot="action59image">
                    <span slot ="action60text">Now only the score of the player hitting the enemy has its score increased.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon114.gif" slot="action60image">
                    <span slot ="action61text">To resolve bullets still shooting when player is disabled. The reason is because the root being disabled is the child of the gameobject that the Player.cs is attached to, therefore, Player.cs is still running. Therefore, I can check if root is active in hierarchy or not. Since when the player collides with the enemy, the root gets disabled</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon115.PNG" slot="action61image">
                    <span slot ="action62text">The result shows the bullets stops shooting when the player is disabled. Let's continue syncing gameobjects in Part 6 which can be found <a href="blogfirstandroidgame6.html">here</a></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon116.gif" slot="action62image">
                </blogcontent-component>
            </section>

            <section class="blogrecent">
                <blogrecent-component>
                    <span slot="recentblogs">Recent blogs</span>
                    <span slot="seeallblogs"><a href="index.html#blog">See all blogs</a></span>
                </blogrecent-component>

            </section>
    </section>
    

 


    <section class="footer-section bg-js-controlled" id="contact">
        <footer-component></footer-component>
    </section>


    
    
</body>
</html>

