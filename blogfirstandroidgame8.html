<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Android Game - Eldon Lin Portfolio</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/blogproject.css">
    <script src="js/app.js" defer></script>
    <script src="js/component/header.js" defer></script>
    <script src="js/component/footer.js" defer></script>
    <script src="js/component/logo.js" defer></script>
    <script src="js/component/blogintro.js" defer></script>
    <script src="js/component/blogcontent.js" defer></script>
    <script src="js/component/blogrecent.js" defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>
<body>

    <section class="bg-js-controlled">
        <header-component></header-component>
    </section>
    
    <section class="bg-js-controlled">
        <section class="intro">
            <blogintro-component>
                <span slot ="title">First Android Game - Part 8 - Collecting coins</span>
                <span slot="date">July 21, 2023</span>
                <button slot="vlogbutton" onclick="OnLinkClick('https://www.youtube.com/playlist?list=PLJJXiMHWLgloHkx0DWFJtN_Min3OEU-T4')">Watch youtube playlist</span>               
            </blogintro-component>
        </section>
    
    
            <section class="diarypost">
                <blogcontent-component>
                    <span slot ="action1text">This is part 8 of making my first Android Game. If you missed part7, you can find it <a href="blogfirstandroidgame7.html">here</a></span>
                    <span slot ="action2text">To collect coins I am going to spawn them with the same logic that I spawned the enemeis. In CoinPoolInstance.cs I am using the same spawn location gameobject I used for spawning the enemies. There aren't any coin types anymore and the coin prefabs are on the Instance.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon149.PNG" slot="action2image">
                    <span slot ="action3text">On CoinPoolInstance.cs, I have the master calling the spawning coins coroutines</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon150.PNG" slot="action3image">
                    <span slot ="action4text">The coroutines chooses a random location to spawn the coins, just like the enemies</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon151.PNG" slot="action4image">
                    <span slot ="action5text">On Coin.cs I am getting the PhotonView component. All the Coin prefab have a PhotonView component and a Photon Transform Classics View component with Synchronize Position</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon152.PNG" slot="action5image">
                    <span slot ="action6text">The OnTriggerEnter2D in Coin.cs checks if view.IsMine, if it is call a RPC function named CoinCollected and Calls PhotonNetwork.Destroy</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon153.PNG" slot="action6image">
                    <span slot ="action7text">The CoinCollected RPC function spawns the coin text</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon154.PNG" slot="action7image">
                    <span slot ="action8text">The Coroutine EnabledObject() in Coin.cs checks how long the coin stays before getting destroyed</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon155.PNG" slot="action8image">
                    <span slot ="action9text">In CoinTExt.cs, it is reduced to the same logic as Explosion.cs where it gets Destroyed after timeBeforeDestroy seconds. In Update(), the text will be translated upwards. I am not worried about the text location getting synced because it will be roughly in the same location as where the coin is</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon156.PNG" slot="action9image">
                    <span slot ="action10text">After testing, some bugs were noticed: (1) sometimes when two coins are close to each other and are collected at the same time, only one coin amount is added, this occurs on develop branch as well so this bug existed before the changes. </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon157.PNG" slot="action10image">
                    <span slot ="action11text">(2)On the client side, sometimes the number of coins does not get added even though it is collided with the player. I added Debug.Log() in Player.cs where there is a check if Player collides with the coin, and the Debug.Log does not always get printed. From the results below, you can see that even though the coins collides with the player, it doesn't always print out the Debug.Log, however, the coins always disappears and the cointext is always spawned. This means on the Master, the PunRPC function that spawns the text is being called, but the collision is not being detected on the client side</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon158.gif" slot="action11image">
                    <span slot ="action12text">My hunch with the issue of the number of coins not getting added was due to PhotonNetwork.Destroy() getting called on the coins on master side before the client player collides with the coin. I thought of this because this issue appears to occur only if the coin collides with the client player head on in the front. This never occurs if the coin collides with the player on the side. Also, the RPC function which gets called on master only that spawns the coin text is always triggered but the coin does not always get added. So I did a test on EnemyBase.cs, if the enemy collides with the player, destroy the enemy. I also disabled the bullet so I can have the player collide with the enemy. In Player.cs, if the player collides with the enemy, print out enemy hit to the console. My hunch was correct as shown in the result. Now the question is how would I resolve this? This issue is occuring for both enemy and coin. Enemy was not noticeable because the bullet destroyed the enemy before hitting the player in the front </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon159.gif" slot="action12image">
                    <span slot ="action13text">I thought instead of doing PhotonNetwork.Destroy() in coin.cs, I can do it on Player.cs when player collides with the coin</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon160.PNG" slot="action13image">
                    <span slot ="action14text">However, that did not work and I just got errors if the client player tries to destroy the coins using PhotonNetwork.Destroy(collision.gameobject)</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon161.PNG" slot="action14image">
                    <span slot ="action15text">I tried a different approach similar to how I spawn the bullets and assign a Photon.Realtime.Player to the owner. In this case, I assign the the Photon.Realtime.Player to the Coin's Owner in Coin.cs when the coin collides with the player. Player.cs would a property so I can access Photon.Realtime.Player.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon162.PNG" slot="action15image">
                    <span slot ="action16text">That did not work because on the master, when the client player collides with the coin, the Photon.Realtime.Player is null.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon163.PNG" slot="action16image">
                    <span slot ="action17text">I thought adding a null check would resolve everything. However, all it resolved was the null error. The issue with the coins not getting added issue still persists. It appears that when the client collides with the coins, PunRPC function gets called, the destroyed, but the AddCoins might not have been sent over in time. However, even this logic would conflict, because it isn't always happening and  the coins only doesn't get added when the coin hits the front of the player but not the side.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon164.PNG" slot="action17image">
                    <span slot ="action18text">Coin.cs I added debug logs to see when when owner is null or not null gets called.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon165.PNG" slot="action18image">
                    <span slot ="action19text">Coin.cs I added debug logs to see destroyed(master) and disabled(client) gets called</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon166.PNG" slot="action19image">
                    <span slot ="action20text">Coin.cs I added debug logs to see when PunRPC gets called</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon167.PNG" slot="action20image">
                    <span slot ="action21text">PlayerInformation.cs I added debug logs to see when AddCoins is called. I noticed that the client sometimes only has PunRPC getting called. This tells me that the master could call PhotonNetwork.Destroy() first before the client can do anything, including OnTriggerEnter2D</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon168.PNG" slot="action21image">
                    <span slot ="action22text">I discarded the changes. In Coin.cs, when the coin collides with the player, I would get PhotoView component and call a public RPC function from the Player.cs</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon169.PNG" slot="action22image">
                    <span slot ="action23text">In Player.cs, the RPC function would add the coins to the players</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon170.PNG" slot="action23image">
                    <span slot ="action24text">From the result you can see the coins getting added even when it is the client!</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon171.gif" slot="action24image">
                    <span slot ="action25text">However, a new problem occured, the coins does not always get added on the client when colliding from the side or the collection would be delayed.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon172.gif" slot="action25image">
                    <span slot ="action26text">This confused me very much so I recorded both the client and the master. Below is the master recording. You can see that the client player did not collide with the treasure chest and the coin the near end so it makes sense the coin is not collected</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon173.gif" slot="action26image">
                    <span slot ="action27text">However, when I looked at the recording for the client, it looks like the client player collided with the treasure chest and the coin at the end. This now makes sense why the coin was not collected, because in Coin.cs it checks for PhotonView.IsMine before adding the coin. So the problem was not the code, I think it may be the positions of the coins not being synced up</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon174.gif" slot="action27image">
                    <span slot ="action28text">I took a screen shot of where the treasure chest was on the master</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon175.PNG" slot="action28image">
                    <span slot ="action29text">I took a screen shot of where the treasure chest was on the client as well. Based on the testing, it seems like it's is because the player movement not being synced up at the exact time cause this mishap. This may also be the reason why when two coins are touched, both don't get added. However, I have encountered this issue after the changes</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/photon176.PNG" slot="action29image">
                                       
                </blogcontent-component>
            </section>

            <section class="blogrecent">
                <blogrecent-component>
                    <span slot="recentblogs">Recent blogs</span>
                    <span slot="seeallblogs"><a href="index.html#blog">See all blogs</a></span>
                </blogrecent-component>

            </section>
    </section>
    

 


    <section class="footer-section bg-js-controlled" id="contact">
        <footer-component></footer-component>
    </section>


    
    
</body>
</html>

