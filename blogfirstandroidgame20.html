<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First Android Game - Eldon Lin Portfolio</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/blogproject.css">
    <script src="js/app.js" defer></script>
    <script src="js/component/header.js" defer></script>
    <script src="js/component/footer.js" defer></script>
    <script src="js/component/logo.js" defer></script>
    <script src="js/component/blogintro.js" defer></script>
    <script src="js/component/blogcontent.js" defer></script>
    <script src="js/component/blogrecent.js" defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>
<body>

    <section class="bg-js-controlled">
        <header-component></header-component>
    </section>
    
    <section class="bg-js-controlled">
        <section class="intro">
            <blogintro-component>
                <span slot ="title">First Android Game - Part 20 - Save data - MySQL</span>
                <span slot="date">Oct 08, 2023</span>
                <button slot="vlogbutton" onclick="OnLinkClick('https://youtu.be/fHY3aUUX3r4')">Watch on youtube</span>   
            </blogintro-component>
        </section>
    
    
            <section class="diarypost">
                <blogcontent-component>
                    <span slot ="action1text">This is part 20 of making my first Android Game. If you missed part19, you can find it <a href="blogfirstandroidgame19.html">here</a>. There are weapons that the user can buy. If the user starts the game over and come back into the game, it would be great if what they bought are carried over. It can be frustrating for the user if all the weapons are gone. We will be exploring different ways to save data. The first one we will explore is MySQL. I will be following this <a href="https://www.youtube.com/watch?v=SKbY-0zt2VE&list=PL5KbKbJ6Gf99mcmE1ptsn0oXO1_vnKDlS&index=3">Tutorial playlist by BoardToBits</a></span>
                    <span slot ="action2text">To create a database I will need to setup a local server. Therefore, I will download MAMP from this <a href="https://www.mamp.info/en/windows/">site</a>. When I open MAMP, I will first go to MAMP > Preferences > Server and change the Document Root. This is where all the PHP files will be stored</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql1.PNG" slot="action2image">
                    <span slot ="action3text">I'll need setup the database. Select the Open WebStartPage. A http://localhost/MAMP/ will open. localhost refers to the root that we set in Web Server Document Root. MAMP is the splash page that MAMP made. We will select the hyper link that says phpMyAdmin</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql2.PNG" slot="action3image">
                    <span slot ="action4text">At the home page select user accounts. You will see a "root" user account. This is the default. If you decide to make your application for public to use, you should create your own user account with a new user name and password</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql3.PNG" slot="action4image">
                    <span slot ="action5text">Now we need to create a database to connect. Select database, I will name my database unity-sql-learning. Select create</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql4.PNG" slot="action5image">
                    <span slot ="action6text">Create a table for the database. Name it player and set number of columns to 5</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql5.PNG" slot="action6image">
                    <span slot ="action7text">There are 5 rows where we need to populate information about them. Each row we will need to provide information about them. Those are the name, type, length/values, default, coaliation, Null, index, A_I, and comments.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql6.PNG" slot="action7image">
                    <span slot ="action8text">The first information is a unique identifier called id. We want the id to differentiate the players. Type is int, give a length 10. We won't worry about default, coliation and attributes. NULL is false. The index will be PRIMARY. A_I is autoincrement, set that to true. Next one is username, type is VARCHAR which is a combination of letters and numbers. Max length is 16 character. Skip default(because we want someone to populate this field), coaliation, attribute, null. Index needs to be unique. Skip A_I. Next is password, but we won't store password as plain text for security reasons. We will use hash and salt. Set both to VARCHAR because a good password have different characters. Length is 100 and 50 respectively. Skip the rest. Lastly is the score - this is the game data we want to store. Type is INT. Length is 10. Default as As defined and set to 0 because by default the score is 0. Skip the rest. Make sure you save. </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql7.PNG" slot="action8image">
                    <span slot ="action9text">I will be using sublime text to code my php. Sublime can be downloaded <a href="https://www.sublimetext.com/">here</a>. In Unity, we will create 4 scenes: Main Menu, Login, Register, Game. Main Menu will have 3 buttons: RegisterMenu, Login, Play Game  and a text that tells us if the user is logged in. RegisterMenu has a button that says register and two input fields that lets user enter their username and password. Login Scene has the same two inputfields as Register but the button will say Log in. Game Scene will have a button the increments the score and a button that exits the game and go back to Main Menu scene. In the Main Menu Scene and RegisterMenu scene, attach a script called MainMenu.cs and Registeration.cs to the canvas respectively. The MainMenu.cs will have reference to all 3 buttons and the text. Create a function for each button so that the user presses Register, Login and PlayGame button it will load the RegisterMenu scene, Login Scene and Game scene. I will wrap this code in the namespace MySQLLearning so that it does not conflict with my tomato vs potato game. This is because these scripts are for testing.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql8.PNG" slot="action9image">
                    <span slot ="action10text">Attach a reference the OnClick on each button. For example, the Login has a reference to the canvas and the function is <code>GoToLogin()</code></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql9.PNG" slot="action10image">
                    <span slot ="action11text">In Registration.cs, I have a reference to the inputfields and the register button. The register button is not interactable at the start. It is also not interactable if the number of characters in username and password are less then 8 characters</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql10.PNG" slot="action11image">
                    <span slot ="action12text">On the inputfields for username and password in RegisterMenu scene, attach a reference to <code>VerifyInput</code> to On Value Changed</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql11.PNG" slot="action12image">
                    <span slot ="action13text">Create a public function called <code>CallRegister()</code> which will call a coroutine called <code>RegisterRoutine()</code>. On the Register button, have the OnClick reference to <code>CallRegister()</code></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql12.PNG" slot="action13image">
                    <span slot ="action14text">The <code>RegisterRoutine()</code> will make a post to the url specified. In this case it is <code>http://localhost/register.php</code> which is where our <code>register.php</code> script will be saved. In the form it will pass in the username and password that the user has entered in the inputfield. This will be passed into a <code>WWWForm</code></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql13.PNG" slot="action14image">
                    <span slot ="action15text">The routine will wait for the webrequest to finish making its request. If it fails due to Connection error, processing error or protical error. It will try again until its reaches the <code>const int MAX_REQUEST_ATTEMPT_COUNT</code> which I set to 2. Then it will print out the downloadhandler information</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql14.PNG" slot="action15image">
                    <span slot ="action16text">If the request succeeds, I will check if the downloadhandler text does not contain a "0". This 0 will be from <code>echo</code> from the <code>register.php</code>. a non 0 will be an error code we add in a bit. If there is a 0, then everything passed and we load into the Login scene.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql15.PNG" slot="action16image">
                    <span slot ="action17text">Now we will go into sublime text to create register.php. I will be saving this php script in the folder specified in the document root. In any php scripts, we need to encapsulate them in <code><?php ?></code>. We will make a connection to our database. We will store that in a variable called <code>$con</code>. To connect to the database will make a function call <code>mysqli_connect()</code>. We will pass into the function the location of the database, which in this case is <code>localhost</code>. Then the user name which in this case is <code>root</code>, and also the password which is <code>root</code>. The password won't be seen in the browser and only stored on the backend so it is ok to hardcode the password here. Lastly we put in the database which in this case is <code>unity-sql-learning</code>. Now we want to check if the connection happened by doing an if statement to see if there were any errors <code>mysqli_connect_errno()</code>. If there is, we will <code>echo 0</code>. Echo is like debug log, it's the text the prints into the downloadhandler text. We will <code>echo 1</code> if there is an error. We will <code>exit()</code> if there is an error. If it is successful, we will create a variable called <code>username</code> and <code>password</code>. Remember we get the username and password from the <code>WWWForm</code>. Using <code>$_POST</code> where <code>$_</code> means it is a constant thing and we check for <code>POST</code> to see if there is the variable name and password from the form. Next we will double check if the name already exist, if the name exist we will not allow the user to add the name by using a query. First we create a variable called <code>namecheckquery</code>. We set the variable to <code>"SELECT username FROM players WHERE username='" . $username . "';";</code> player is the table and username is the column. We concatenate a string by using periods <code>.</code> which is the php version of concatenating. Next, we create a variable <code>namecheck</code> which is set to a function call <code>mysqli_query()</code>. This function takes in our connection variable <code>con</code> our query variable <code>namecheckquery</code>. If this query did not work we say <code>or die("2: Name check query failed")</code> which will exit the code AND display information "2". Now we see if this name exists by checking if any rows were returned by doing an if statement and checking <code>mysqli_num_rows($namecheck) > 0</code>. If this is true then the name exists and we echo an error code. Otherwise, everything passed then we can add the user to the table.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql16.PNG" slot="action17image">
                    <span slot="action18text">We need to make sure to salt and hash the password because we can't store passwords as plain text. Hashing means they can't immediately some information and get some password. Salting means we don't let hackers use lookup tables to break through encrypted passwords. So first create a <code>salt</code> variable. Assign it to <code>\$5\$rounds=5000\$</code>. Note the \ tells us write the actual symbol, in this case the $ symbol. The $ symbol is not any thing special. We are using a SHA256 to encrypt passwords (indicated by the 5), it will use 5000 shifts and come up with a nest of code to encrypt the password. We then concatenate an additional line, can be anything that we want. We want a 16 character salt, and in this case we use the username as part of the salt. We pass in the username and concatenate on last <code>\$</code>. The hash variable will be assigned to <code>crypt($password, $salt)</code> Then we will use the query that inserts the information into the database. <code>"INSERT INTO players (username, hash, salt) VALUES ('" . $username . "', '" . $hash . "', '" . $salt . "');";</code> we will send this query by doing <code>mysqli_query($con, $insertuserquery) or die("4: Insert player query failed");</code>. Lastly we will echo 0! Remember 0 is how we check downloadhandler text in our Registeration.cs</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql17.PNG" slot="action18image">
                    <span slot="action19text">Now when a user successfully registers, the player table will have a row. Notice that the ID is 3, meaning this is the the 3rd person that registered because autoicrement the id. The salt and hash are encrypted. Score by default is 0</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql18.PNG" slot="action19image">
                    <span slot="action20text">Now we will be logging into the database and access player's information and use it in our game. A script called <code>Login</code> will be added to the canvas in Login scene. In the script, we are going do simliar logic with the register button. The submit button is only interactable when the inputfield username and password have more then 8 characters </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql19.PNG" slot="action20image">
                    <span slot="action21text">When the login button is pressed, it will call the Login function which calls the LoginRoutine which will make a POST request, the form will pass in the name field and the password field. The post will go to a script called <code>login.php</code>. If request fails. Print to the console the error </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql20.PNG" slot="action21image">
                    <span slot="action22text">If there are noerrors,we will check the downlohandler text first array has the character 0. We know there must be something in downloadhandler because the request passed. If there is no "0" then there is an error. Otherwise assign the a static username and score from <code>DBManager.cs</code>and load the main menu scene. Note that we are using split and the tab delimiter. We are parsing the string to an integer for our score which will be stored in the second array</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql21.PNG" slot="action22image">
                    <span slot="action23text">The DBManager checks our state. It can check if user is logged in by checking if username is null. This username was assigned in <code>Login.cs</code>. If user logs out we set username to null.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql22.PNG" slot="action23image">
                    <span slot="action24text">In <code>Login.php</code>, we check for connection error, if there is no connection error. We use the same information from <code>register.php</code> to get the name and password because we have the same form structure.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql23.PNG" slot="action24image">
                    <span slot="action25text">Now we check if the name exists. We check if <code>mysqli_num_rows($namecheck) !=1</code> then the name doesn't exist, we will echo an error code 5. Next we check the password. In <code>register.php</code> we hashed and salt. However this time we need to get the hash and salt and compare to the password the user has logged in with to see if they match. We will get login info from query. Notice the <code>$namecheckquery</code> is retrieving the username, salt and hash. The <code>$existinginfo</code> is assigned to <code>mysqli_fetch_assoc($namecheck)</code> then we convert exisitinginfo to salt and hash. The <code>$loginhash</code> will be assigned to <code>crype</code> which takes in the password and the salt from our table. If the exisiting hash does not match the login hash meaning not matching what it is stored in the table. In this case we echo the error code 6 - incorrect password. Otherwise, user logined successfully then we can return "0". We will use <code>\t</code> to separate the information and then return score from <code>$exisitinginfo</code>. <code>$exisitinginfo</code> has score because of our <code>$namecheckquery</code> where it has <code>score</code> in the <code>query</code></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql24.PNG" slot="action25image">
                    <span slot="action26text">In <code>MainMenu.cs</code>, we can check if the user is logged in by displaying the logged in user text and also enable/disable the buttons depending on if the users are logged in.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql25.PNG" slot="action26image">
                    <span slot="action27text">Now we want to save user data in the game scene. Specifically we want to save the user's score. A <code>Game.cs</code> is created and attached to the canvas in the Game scene. We will have two text field, one for the player's name and one for the score.  </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql26.PNG" slot="action27image">
                    <span slot="action28text">There will be a button to increment the score by one. This will be assigned and added to <code>DBManager.score</code></span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql27.PNG" slot="action28image">
                    <span slot="action29text">There will be an exit button. When the exit button is selected, it will send a POST request to <code>savedata.php</code> to save the score to the user we want to save to. The form will be storing username and score. Again if the request fails, we print to the console the error</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql28.PNG" slot="action29image">
                    <span slot="action30text">If the request succeeds, we check that the php did not echo 0. If it is not 0 then something went wrong. Otherwise logout and go to main menu scene. </span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql29.PNG" slot="action30image">
                    <span slot="action31text">In <code>savedata.php</code>, we again first connect to our database and make sure there are not connection error. We create two variables and check for name and score because that's what the form from Unity was sending</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql30.PNG" slot="action31image">
                    <span slot="action32text">Our query will be checking if the username from player table matches the username being sent from the form. If the username does not exist, print out an error code. Otherwise if the username exist then we will use the Update query like this to store the score to the matching username <code> "UPDATE players SET score = " . $newscore . " WHERE username = '" . $username . "';"</code>. This query is stored in the variable<code>updatequery</code>. We then send it to our database where the variable <code>con</code> has our database info <code>mysqli_query($con, $updatequery)</code>. We will also do a <code>or die("7: Save query failed")</code> if something failed.</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql31.PNG" slot="action32image">
                    <span slot="action33text">Below shows how register works in game and in the database</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql32.gif" slot="action33image">
                    <span slot="action34text">Below shows how login and saving score works in game and in the database</span>
                    <img class="diarypostimage" src="images_videos/blog/FirstAndroidGame/mysql32.gif" slot="action34image">
                    <span slot="action35text">See part 21 <a href="blogfirstandroidgame21.html">here</a></span>


                                 
                </blogcontent-component>
            </section>

            <section class="blogrecent">
                <blogrecent-component>
                    <span slot="recentblogs">Recent blogs</span>
                    <span slot="seeallblogs"><a href="index.html#blog">See all blogs</a></span>
                </blogrecent-component>

            </section>
    </section>
    

 


    <section class="footer-section bg-js-controlled" id="contact">
        <footer-component></footer-component>
    </section>


    
    
</body>
</html>

